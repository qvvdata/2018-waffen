---
title: "waffenbranche"
subtitle: "analyse der firmen und exporte"
author: "tbd"
date: "07-2018"
output:
  html_document:
    code_folding: show
    toc: yes
    toc_float: 
      collapsed: false
      smooth_scroll: false
---


```{r, echo=FALSE}
# CONFIG
user_name <- "qvvdata" # your Git username (only needed if
# you want to deploy to GH pages)
project_name <- "2018-waffen" # adapt!
package_date <- "2019-02-02" # date of the CRAN snapshot that
# the checkpoint package uses
```

## Notes

This report was generated on `r Sys.time()`.

...

### R-Script & data

The preprocessing and analysis of the data was conducted in the [R project for statistical computing](https://www.r-project.org/). The RMarkdown script used to generate this document and all the resulting data can be downloaded [under this link](http://`r user_name`.github.io/`r project_name`/rscript.zip). Through executing `main.Rmd`, the herein described process can be reproduced and this document can be generated. In the course of this, data from the folder `ìnput` will be processed and results will be written to `output`. 
The code for the herein described process can also be freely downloaded from [https://github.com/`r user_name`/`r project_name`](https://github.com/`r user_name`/`r project_name`). 

## Preparations

```{r, echo=FALSE}
detach_all_packages <- function() {
  basic_packages_blank <-  c("stats",
                             "graphics",
                             "grDevices",
                             "utils",
                             "datasets",
                             "methods",
                             "base")
  basic_packages <- paste("package:", basic_packages_blank, sep = "")

  package_list <- search()[
    ifelse(unlist(gregexpr("package:", search())) == 1, TRUE, FALSE)]

  package_list <- setdiff(package_list, basic_packages)

  if (length(package_list) > 0)  for (package in package_list) {
    detach(package, character.only = TRUE, unload = TRUE)
    print(paste("package ", package, " detached", sep = ""))
  }
}

detach_all_packages()

# this allows multiple persons to use the same RMarkdown
# without adjusting the working directory by themselves all the time
source("scripts/csf.R")
path_to_wd <- csf() # if this - for some reason - does not work, 
# replace with a hardcoded path, like so: "~/projects/rddj-template/analysis/"
if ( is.null(path_to_wd) | !dir.exists(path_to_wd)) {
  print("WARNING: No working directory specified for current user")
} else {
  setwd(path_to_wd)
}
```


### Define packages

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# from https://mran.revolutionanalytics.com/web/packages/checkpoint/vignettes/using-checkpoint-with-knitr.html
# if you don't need a package, remove it from here (commenting is probably not sufficient)
# tidyverse: see https://blog.rstudio.org/2016/09/15/tidyverse-1-0-0/
cat("
library(tidyverse) # ggplot2, dplyr, tidyr, readr, purrr, tibble
library(magrittr) # pipes
library(stringr) # string manipulation
library(readxl) # excel
library(generics)
library(scales) # scales for ggplot2
library(jsonlite) # json
library(forcats) # easier factor handling,
library(lintr) # code linting
library(xlsx) #Excel
library(googlesheets) # googlesheets (replace with googlesheets4 asap)",
file = "manifest.R")
```

### Install packages

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# if checkpoint is not yet installed, install it (for people using this
# system for the first time)
if (!require(checkpoint)) {
  if (!require(devtools)) {
    install.packages("devtools", repos = "http://cran.us.r-project.org")
    require(devtools)
  }
  devtools::install_github("checkpoint",
                           username = "RevolutionAnalytics",
                           ref = "v0.3.2", # could be adapted later,
                           # as of now (beginning of July 2017
                           # this is the current release on CRAN)
                           repos = "http://cran.us.r-project.org")
  require(checkpoint)
}
# nolint start
if (!dir.exists("~/.checkpoint")) {
  dir.create("~/.checkpoint")
}
# nolint end
# install packages for the specified CRAN snapshot date
checkpoint(snapshotDate = package_date,
           project = path_to_wd,
           verbose = T,
           scanForPackages = T,
           use.knitr = F)
rm(package_date)
```


### Load packages

```{r, echo=TRUE, message=FALSE, warning=FALSE}
source("manifest.R")
unlink("manifest.R")
sessionInfo()
```

### Load additional scripts

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# if you want to outsource logic to other script files, see README for 
# further information
knitr::read_chunk("scripts/theme_addendum.R")
source("./scripts/theme_addendum.R")
source("./scripts/BorderMan.R")
#source("./scripts/01-preprocessing.R")
cat(getwd())
options(scipen=999)

```




```{r, echo=TRUE, message=FALSE, warning=FALSE}
#WHAT ARE THE RELEVANT ML-CATEGORIES FOR AUSTRIA FOR EXPORTED GOODS?

exports_sumat <- exports %>%
  filter(category =="c") %>%
  #filter(year!="2017") %>%
  filter(name_source_country == "Austria") %>%
  group_by(wkdok)%>%
  summarise(mlsum= sum(value))

write_excel_csv(exports_sumat, "output/exports_sumat.csv")

# In wie viele Länder hat Österreich seit 2004 welche Militärgüter exportiert?
exports_country_count_at <- exports %>%
  filter(category =="c") %>%
  #filter(year!="2017") %>%
  filter(name_source_country == "Austria") %>%
  distinct(name_destination_country, wkdok, .keep_all = TRUE) %>%
  group_by(wkdok) %>%
  summarise(country= n())

# Ansehen, welche Länder das waren
exports_country_sum_at <- exports %>%
  filter(category =="c") %>%
  #filter(year!="2017") %>%
  filter(name_source_country == "Austria") %>%
  group_by(name_destination_country) %>%
  summarise(mlsum = sum(value))

# In wie viele Länder hat Österreich seit 2004 insgesamt exportiert?
exports_country_count_at_total <- exports %>%
  filter(category =="c") %>%
  #filter(year!="2017") %>%
  filter(name_source_country == "Austria") %>%
  distinct(name_destination_country, .keep_all = TRUE) %>%
  group_by(name_source_country) %>%
  summarise(country= n())

#Entwicklung von Waffen und Munition
exports_timeat_waffen <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="Waffen & Munition")%>%
  group_by(name_destination_country_german)%>%
  summarise(mlsum= sum(value))

write_excel_csv(exports_sumat, "output/exports_timeat.csv")

#Wohin gehen österreichische Waffen- und Munitionsexporte
exports_destination_at <- exports %>%
  filter(category == "c") %>%
  filter(name_source_country == "Austria") %>%
  filter(wkdok=="Waffen & Munition") %>%
  group_by(iso_destination_country, name_destination_country, lat_destination_country, long_destination_country)%>%
  summarise(mlsum= sum(value))

write_excel_csv(exports_destination_at, "output/exports_destination_at.csv")

##Wohin gehen österreichische Fahrzeugexporte?
exports_vehicles_destination_at_total_markets <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="VEHICLES & ACCESSORIES")%>%
  group_by(region_name) %>%
  summarise(mlsum= sum(value))

##Welcher Fahrzeugmarkt ist der wichtigste?
exports_vehicles_destination_at_total <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="VEHICLES & ACCESSORIES")%>%
  group_by(name_destination_country, long_destination_country, lat_destination_country, wkdok,
           lat_source_country, long_source_country)%>%
  summarise(mlsum= sum(value))

# Wie viele gehen in den Mittleren Osten?
exports$name_destination_country_german <- countrycode(exports$iso_destination_country, "iso2c", "country.name.de")

exports_vehicles_destination_at_ME <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="VEHICLES & ACCESSORIES" & region_name=="Middle East")%>%
  group_by(name_destination_country, long_destination_country, lat_destination_country,            name_destination_country_german) %>%
  summarise(mlsum= sum(value)) %>%
  mutate(mlsum_text  = as.character(round((mlsum/1000000), 1))) 

write_excel_csv(exports_vehicles_destination_at_ME, "output/exports_vehicles_destination_at_ME_2017.csv")
write.xlsx(as.data.frame(exports_vehicles_destination_at_ME), "output/exports_vehicles_destination_at_ME_2017.xls")

#Welche Regionen wichtig?
exports_vehicles_destination_region_at <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="VEHICLES & ACCESSORIES")%>%
  group_by(region_name, wkdok,
           lat_source_country, long_source_country)%>%
  summarise(mlsum= sum(value))

#PERSONAL EQUIPMENT

##Wohin gehen österreichische PERSONAL EQUIPMENT exporte?
exports_pe_destination_at <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="PERSONAL EQUIPMENT")%>%
  group_by(iso_destination_country, name_destination_country, wkdok,
           lat_source_country, long_source_country, lat_destination_country, long_destination_country)%>%
  summarise(mlsum= sum(value))
write_excel_csv(exports_pe_destination_at, "output/exports_pe_destination_at.csv")

#Welche Regionen wichtig?
exports_pe_destination_region_at <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="PERSONAL EQUIPMENT")%>%
  group_by(region_name, wkdok,
           lat_source_country, long_source_country)%>%
  summarise(mlsum= sum(value))

#PERSONAL EQUIPMENT

##Wohin gehen österreichische Militärgüter insgesamt
exports_total_destination_at <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria")%>%
  group_by(iso_destination_country, name_destination_country,
           lat_source_country, long_source_country, lat_destination_country, long_destination_country)%>%
  summarise(mlsum= sum(value))
write_excel_csv(exports_total_destination_at, "output/exports_total_destination_at.csv")

#Welche Regionen wichtig?
exports_pe_destination_region_at <- exports %>%
  filter(category =="c") %>%
  filter(name_source_country == "Austria" & wkdok=="PERSONAL EQUIPMENT")%>%
  group_by(region_name, wkdok,
           lat_source_country, long_source_country)%>%
  summarise(mlsum= sum(value))

```

Zwischen 2004 und 2016 haben österreichischen Waffenhersteller Produkte im Wert von XY Milliarden Euro ins Ausland exportiert.

Am wichtigsten ist der Sektor der kleinkalibrigen Waffen. Das Exportvolumen betrug 2,3 Milliarden Euro. 

```{r}
needs(pkgbuild, pkgload, processx, remotes, sessioninfo, usethis)

devtools::install_github("xmarquez/democracyData")
library(democracyData)
needs(countrycode)

eiu <- eiu

eiu <- eiu %>%
  mutate(class = ifelse(eiu>=8, "Vollständige Demokratie", 
                        ifelse(eiu>=6, "Unvollständige Demokratien", 
                               ifelse(eiu>=4, "Hybridregime", "Autoritäres Regime"))))

eiu$iso3 <- countrycode(eiu_temp$GWn, "gwn", "iso3c") 
eiu$iso2 <- countrycode(eiu_temp$GWn, "gwn", "iso2c") 
                               

exports_democracy <- exports %>%
  filter(year>2012, iso_source_country=="AT") %>%
  left_join(eiu, by=c("year"="year", "iso_destination_country"="iso2")) 
  
  
exports_democracy_sumat <- exports_democracy %>%
  filter(category =="c") %>%
  #filter(year!="2017") %>%
  filter(name_source_country == "Austria" & class=="Autoritäres Regime") %>%
  group_by(class, name_destination_country) %>%
  summarise(mlsum= sum(value))%>%
  arrange(desc(mlsum))%>%
  top_n(mlsum, n=7)
write.xlsx(as.data.frame(exports_democracy_sumat), "output/ignore/exports_democracy_sumat.xlsx")


```

# Wie viel Exporte in Konfliktparteien des Golfrates?
```{r}
yemen_conflictparties <- c("Bahrain", "Kuwait", "Qatar", "Saudi Arabia", "Senegal", "Sudan", "Morocco", "Egypt", "Jordan", "United Arab Emirates", "Yemen")

exports_sumat_yemen <- exports %>%
  filter(category =="c") %>%
  filter(year>="2015") %>% # Konflikt beginnt im März 2015
  filter(name_destination_country %in% yemen_conflictparties) %>%
  filter(name_source_country == "Austria") %>%
  group_by(name_source_country, name_destination_country) %>%
  summarise(mlsum= sum(value)) %>%
  arrange(desc(mlsum))

write.xlsx(as.data.frame(exports_sumat_yemen), "output/ignore/exports_sumat_yemen_wk.xlsx")

unique(exports_democracy$class)

```
```{r}
# In der EU gelten derzeit Waffenembargos gegen 19 Staaten: Afghanistan, China, Demokratische Republik Kongo, Eritrea, Iran, Irak, Jemen, Libanon, Libyen, Myanmar, Nordkorea, Russland, Simbabwe, Somalia, Südsudan, Sudan, Venezuela, Zentralafrikanische Republik und Weißrussland. Hinzu kommt ein Embargo gegen die Terrorgruppen "Islamischer Staat" (IS) und Al-Kaida.

embargo_eu <- c("Afghanistan", "China", "South Sudan", "Congo", "Eritrea", "Sudan", "Russia", "Libya", "Iran", "Iraq", "Yemen", "Lebanon", "North Korea", "Myanmar", "Central African Republic", "Zimbabwe", "Belarus", "Venezuela", "Somalia")

exports_sumat_embargo <- exports %>%
  filter(category =="c") %>%
  filter(year>="2017") %>% # 
  filter(name_destination_country %in% embargo_eu) %>%
  filter(name_source_country == "Austria")


# Testen, ob es keine Doppelbuchungen gab
exports_dup_at <- exports %>%
  filter(name_source_country == "Austria") %>%
  distinct(year, iso_source_country, iso_destination_country, value, category, .keep_all = TRUE)

exports_at <- exports %>%
  filter(name_source_country == "Austria")

```


## Linting

The code in this RMarkdown is listed with the [lintr package](https://github.com/jimhester/lintr), which is based on the  [tidyverse style guide](http://style.tidyverse.org/). 

```{r echo=TRUE, message=FALSE, warning=FALSE}
lintr::lint("main.Rmd")
# if you have additional scripts and want them to be linted too, add them here
```


